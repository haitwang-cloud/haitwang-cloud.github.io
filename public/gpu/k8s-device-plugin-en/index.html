<!doctype html>




<script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1313460867822205"
     crossorigin="anonymous"></script>





































<html
  class="not-ready lg:text-base"
  style="--bg: #f8f5d7"
  lang="zh-CN"
>
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, shrink-to-fit=no"
  />

  
  <title>Kubernetes GPU Management Basics: Introduction to Device Plugin and Source Code Analysis - Tim Wang Tech Blog</title>

  
  <meta name="theme-color" />

  
  
  
  
  <meta name="description" content="Introduction In a Kubernetes cluster, certain workloads require access to hardware resources on the nodes, such as GPUs, FPGAs, and InfiniBand. To enable Kubernetes to recognize and schedule these hardware resources, the concept of Device Plugins was introduced. This article will explain the working principles of Device Plugins in detail.
What is a Device Plugin? A Device Plugin is a special type of plugin in Kubernetes that manages hardware devices on a node and presents device information to Kubernetes." />
  <meta name="author" content="Tim Wang" />
  

  
  
  
  
  
  
  <link rel="preload stylesheet" as="style" href="http://localhost:1313/main.min.css" />

  
  
  
  
  
  <link rel="preload" as="image" href="http://localhost:1313/theme.png" />

  
  
  
  
  <link rel="preload" as="image" href="https://gravatar.com/haitaoking1993" />
  
  

  
  
  <link rel="preload" as="image" href="http://localhost:1313/github.svg" />
  
  <link rel="preload" as="image" href="http://localhost:1313/linkedin.svg" />
  
  <link rel="preload" as="image" href="http://localhost:1313/rss.svg" />
  
  

  
  
  <script
    defer
    src="http://localhost:1313/highlight.min.js"
    onload="hljs.initHighlightingOnLoad();"
  ></script>
  

  
  
  

  
  <link rel="icon" href="http://localhost:1313/favicon.ico" />
  <link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png" />

  
  <meta name="generator" content="Hugo 0.127.0">

  
  
  
</head>

  <body class="text-black duration-200 ease-out dark:text-white">
    <header class="mx-auto flex h-[4.5rem] max-w-3xl px-8 lg:justify-center">
  <div class="relative z-50 mr-auto flex items-center">
    <a
      class="-translate-x-[1px] -translate-y-[1px] text-2xl font-semibold"
      href="http://localhost:1313/"
      >Tim Wang Tech Blog</a
    >
    <div
      class="btn-dark text-[0] ml-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]"
      role="button"
      aria-label="Dark"
    ></div>
  </div>

  <div
    class="btn-menu relative z-50 -mr-8 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden"
    role="button"
    aria-label="Menu"
  ></div>

  

  <script>
    
    const htmlClass = document.documentElement.classList;
    setTimeout(() => {
      htmlClass.remove('not-ready');
    }, 10);

    
    const btnMenu = document.querySelector('.btn-menu');
    btnMenu.addEventListener('click', () => {
      htmlClass.toggle('open');
    });

    
    const metaTheme = document.querySelector('meta[name="theme-color"]');
    const lightBg = '#f8f5d7'.replace(/"/g, '');
    const setDark = (isDark) => {
      metaTheme.setAttribute('content', isDark ? '#000' : lightBg);
      htmlClass[isDark ? 'add' : 'remove']('dark');
      localStorage.setItem('dark', isDark);
    };

    
    const darkScheme = window.matchMedia('(prefers-color-scheme: dark)');
    if (htmlClass.contains('dark')) {
      setDark(true);
    } else {
      const darkVal = localStorage.getItem('dark');
      setDark(darkVal ? darkVal === 'true' : darkScheme.matches);
    }

    
    darkScheme.addEventListener('change', (event) => {
      setDark(event.matches);
    });

    
    const btnDark = document.querySelector('.btn-dark');
    btnDark.addEventListener('click', () => {
      setDark(localStorage.getItem('dark') !== 'true');
    });
  </script>

  <div
    class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"
  >
    
    

    
    <nav
      class="mt-12 flex justify-center space-x-10 dark:invert lg:ml-12 lg:mt-0 lg:items-center lg:space-x-6"
    >
      
      <a
        class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./github.svg)"
        href="https://github.com/haitwang-cloud"
        target="_blank"
        rel="me"
      >
        github
      </a>
      
      <a
        class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./linkedin.svg)"
        href="https://linkedin.com/in/tim-wang-505213166"
        target="_blank"
        rel="me"
      >
        linkedin
      </a>
      
      <a
        class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./rss.svg)"
        href="http://localhost:1313/index.xml"
        target="_blank"
        rel="alternate"
      >
        rss
      </a>
      
    </nav>
    
  </div>
</header>


    <main
      class="prose prose-neutral relative mx-auto min-h-[calc(100%-9rem)] max-w-3xl px-8 pb-16 pt-12 dark:prose-invert"
    >
      

<article>
  <header class="mb-16">
    <h1 class="!my-0 pb-2.5">Kubernetes GPU Management Basics: Introduction to Device Plugin and Source Code Analysis</h1>

    
    <div class="text-sm antialiased opacity-60">
      
      <time>Jun 27, 2024</time>
      
      
      
      
    </div>
    
  </header>

  <section><h2 id="introduction">Introduction</h2>
<p><img src="/pics/plugin01.png" alt="plugin01"></p>
<p>In a Kubernetes cluster, certain workloads require access to hardware resources on the nodes, such as GPUs, FPGAs, and InfiniBand. To enable Kubernetes to recognize and schedule these hardware resources, the concept of Device Plugins was introduced. This article will explain the working principles of Device Plugins in detail.</p>
<h2 id="what-is-a-device-plugin">What is a Device Plugin?</h2>
<p>A Device Plugin is a special type of plugin in Kubernetes that manages hardware devices on a node and presents device information to Kubernetes. Each type of hardware device requires a corresponding Device Plugin process to be running, typically provided by the hardware vendors.</p>
<p>Device Plugins communicate with kubelet through a gRPC service and perform two main functions:</p>
<ol>
<li>Discovering hardware devices on the node</li>
<li>Preparing and setting up the runtime environment for containers that need to use the devices</li>
</ol>
<h2 id="how-device-plugins-work">How Device Plugins Work</h2>
<p><img src="/pics/plugin02.png" alt="plugin02"></p>
<p>Let&rsquo;s explore the workflow of Device Plugins with a concrete example. Suppose a node has three NVIDIA GPU devices installed, and we want to let a Pod use one of these GPU devices.</p>
<h3 id="device-discovery">Device Discovery</h3>
<p>When a node starts, kubelet first initiates all the Device Plugins on that node. For NVIDIA GPU devices, kubelet will start the <code>nvidia-device-plugin</code> process.</p>
<p>This Device Plugin uses the gRPC <code>ListAndWatch</code> remote procedure call to periodically report the list of available GPU devices on the node to kubelet. In our example, the list would be [GPU0, GPU1, GPU2]. Note that this list only contains the IDs of the GPU devices and does not include any detailed information about the devices themselves. Kubelet stores these device IDs in memory and exposes the number of GPUs as Extended Resources via the API Server.</p>
<h3 id="scheduling-decisions">Scheduling Decisions</h3>
<p>When a user wants to create a Pod that uses a GPU, they simply need to add a <code>limits</code> section in the Pod specification, specifying the required number of GPUs, like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cuda-vector-add</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">restartPolicy</span>: <span style="color:#ae81ff">OnFailure</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cuda-vector-add</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#e6db74">&#34;k8s.gcr.io/cuda-vector-add:v0.1&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">nvidia.com/gpu</span>: <span style="color:#ae81ff">1</span> <span style="color:#75715e"># request 1 GPU</span>
</span></span></code></pre></div><h3 id="device-allocation">Device Allocation</h3>
<p><img src="/pics/plugin03.png" alt="plugin03"></p>
<p>Once a node is chosen to run the GPU Pod, kubelet on that node allocates the actual GPU device to the Pod&rsquo;s container. Kubelet sends a gRPC Allocate request to the nvidia-device-plugin, specifying the GPU device ID list.</p>
<p>The nvidia-device-plugin retrieves more details about the specified GPU devices, such as device file paths and driver directories, and returns this information to kubelet via the gRPC response.</p>
<p>In kubelet, handling GPU requests and allocation involves the following code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Containers</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">Resources</span>.<span style="color:#a6e22e">Limits</span>[<span style="color:#e6db74">&#34;nvidia.com/gpu&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// search for available GPUs
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">deviceIDs</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">findAvailableGPUs</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>       <span style="color:#75715e">// handle error
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// allocate the GPU device
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">devicePluginClient</span>.<span style="color:#a6e22e">Allocate</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">TODO</span>(), <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pluginapi</span>.<span style="color:#a6e22e">AllocateRequest</span>{<span style="color:#a6e22e">ContainerRequests</span>: []<span style="color:#f92672">*</span><span style="color:#a6e22e">pluginapi</span>.<span style="color:#a6e22e">ContainerAllocateRequest</span>{{<span style="color:#a6e22e">DevicesIDs</span>: <span style="color:#a6e22e">deviceIDs</span>}}})
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>       <span style="color:#75715e">// handle error
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="container-initialization">Container Initialization</h3>
<p>After kubelet receives the GPU device information from the <code>nvidia-device-plugin</code>, it can create the proper runtime environment for the Pod&rsquo;s container. Kubelet uses the device file paths as the container&rsquo;s <code>Devices</code> parameter and the driver directories as the container&rsquo;s <code>Volume Mounts</code> parameter. These are then passed to the container runtime, such as Docker.</p>
<p>The container runtime uses these parameters to start the container and mount the device resources, allowing the Pod&rsquo;s application to access the assigned GPU device.</p>
<h3 id="source-code-analysis">Source Code Analysis</h3>
<p>For a deeper understanding, let&rsquo;s analyze the source code from <a href="https://github.com/kubernetes/kubernetes/blob/master/pkg/kubelet/cm/devicemanager/manager.go">here</a>.</p>
<p>Kubernetes uses device plugins to manage hardware devices, including GPUs. Device plugins enable third-party resources like GPUs to be recognized and managed by Kubernetes. The core component of this mechanism is <code>ManagerImpl</code>, which is written and run by Kubernetes in kubelet.</p>
<ul>
<li>The <code>ManagerImpl</code> structure manages device plugins. It stores various information about the device plugins, including <code>endpoints</code>, which contains endpoint information for each device plugin. Each endpoint represents a device plugin interface. <code>healthyDevices</code> stores all healthy device resource names and IDs. <code>unhealthyDevices</code> maps device names to sets of device IDs for all unhealthy devices. <code>allocatedDevices</code> maps device names to sets of device IDs for all devices that have been allocated (are in use).</li>
</ul>
<p>By understanding the roles and workflow of Device Plugins, you can efficiently manage hardware resources in your Kubernetes clusters, ensuring that various workloads are met effectively.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ManagerImpl</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">checkpointdir</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">endpoints</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">endpointInfo</span> <span style="color:#75715e">// Key is ResourceName
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">mutex</span>     <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">server</span> <span style="color:#a6e22e">plugin</span>.<span style="color:#a6e22e">Server</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// activePods is a method for listing active pods on the node
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// so the amount of pluginResources requested by existing pods
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// could be counted when updating allocated devices
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">activePods</span> <span style="color:#a6e22e">ActivePodsFunc</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// sourcesReady provides the readiness of kubelet configuration sources such as apiserver update readiness.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// We use it to determine when we can purge inactive pods from checkpointed state.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">sourcesReady</span> <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">SourcesReady</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// allDevices holds all the devices currently registered to the device manager
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">allDevices</span> <span style="color:#a6e22e">ResourceDeviceInstances</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// healthyDevices contains all the registered healthy resourceNames and their exported device IDs.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">healthyDevices</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">sets</span>.<span style="color:#a6e22e">Set</span>[<span style="color:#66d9ef">string</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// unhealthyDevices contains all the unhealthy devices and their exported device IDs.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">unhealthyDevices</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">sets</span>.<span style="color:#a6e22e">Set</span>[<span style="color:#66d9ef">string</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// allocatedDevices contains allocated deviceIds, keyed by resourceName.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">allocatedDevices</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">sets</span>.<span style="color:#a6e22e">Set</span>[<span style="color:#66d9ef">string</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// podDevices contains pod to allocated device mapping.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">podDevices</span>        <span style="color:#f92672">*</span><span style="color:#a6e22e">podDevices</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">checkpointManager</span> <span style="color:#a6e22e">checkpointmanager</span>.<span style="color:#a6e22e">CheckpointManager</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// List of NUMA Nodes available on the underlying machine
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">numaNodes</span> []<span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Store of Topology Affinities that the Device Manager can query.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">topologyAffinityStore</span> <span style="color:#a6e22e">topologymanager</span>.<span style="color:#a6e22e">Store</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// devicesToReuse contains devices that can be reused as they have been allocated to
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// init containers.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">devicesToReuse</span> <span style="color:#a6e22e">PodReusableDevices</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// pendingAdmissionPod contain the pod during the admission phase
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">pendingAdmissionPod</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Pod</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// containerMap provides a mapping from (pod, container) -&gt; containerID
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// for all containers in a pod. Used to detect pods running across a restart
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">containerMap</span> <span style="color:#a6e22e">containermap</span>.<span style="color:#a6e22e">ContainerMap</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// containerRunningSet identifies which container among those present in `containerMap`
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// was reported running by the container runtime when `containerMap` was computed.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// Used to detect pods running across a restart
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">containerRunningSet</span> <span style="color:#a6e22e">sets</span>.<span style="color:#a6e22e">Set</span>[<span style="color:#66d9ef">string</span>]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>The <code>Allocate</code> method is called when a Pod requests device resources from a device plugin, such as a GPU. This method uses <code>container.Resources.Limits</code> to determine the quantity of each device resource needed. It then calls the <code>devicesToAllocate</code> method for each device type, which returns a list of devices that require allocation. For each device resource type, the <code>allocateContainerResources</code>  method is called. This method first tries to allocate devices from the set of healthy devices, updates the podDevices state, and initiates the Allocate request. If the allocation fails, the process rolls back.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ManagerImpl</span>) <span style="color:#a6e22e">Allocate</span>(<span style="color:#a6e22e">pod</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Pod</span>, <span style="color:#a6e22e">container</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// The pod is during the admission phase. We need to save the pod to avoid it
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// being cleaned before the admission ended
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">setPodPendingAdmission</span>(<span style="color:#a6e22e">pod</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">devicesToReuse</span>[string(<span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">UID</span>)]; !<span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">devicesToReuse</span>[string(<span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">UID</span>)] = make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">sets</span>.<span style="color:#a6e22e">Set</span>[<span style="color:#66d9ef">string</span>])
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// If pod entries to m.devicesToReuse other than the current pod exist, delete them.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">podUID</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">devicesToReuse</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">podUID</span> <span style="color:#f92672">!=</span> string(<span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">UID</span>) {
</span></span><span style="display:flex;"><span>			delete(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">devicesToReuse</span>, <span style="color:#a6e22e">podUID</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Allocate resources for init containers first as we know the caller always loops
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// through init containers before looping through app containers. Should the caller
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// ever change those semantics, this logic will need to be amended.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">initContainer</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">InitContainers</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Name</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">initContainer</span>.<span style="color:#a6e22e">Name</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">allocateContainerResources</span>(<span style="color:#a6e22e">pod</span>, <span style="color:#a6e22e">container</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">devicesToReuse</span>[string(<span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">UID</span>)]); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">types</span>.<span style="color:#a6e22e">IsRestartableInitContainer</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">initContainer</span>) {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">podDevices</span>.<span style="color:#a6e22e">addContainerAllocatedResources</span>(string(<span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">UID</span>), <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">devicesToReuse</span>[string(<span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">UID</span>)])
</span></span><span style="display:flex;"><span>			} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// If the init container is restartable, we need to keep the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#75715e">// devices allocated. In other words, we should remove them
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#75715e">// from the devicesToReuse.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">podDevices</span>.<span style="color:#a6e22e">removeContainerAllocatedResources</span>(string(<span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">UID</span>), <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">devicesToReuse</span>[string(<span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">UID</span>)])
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">allocateContainerResources</span>(<span style="color:#a6e22e">pod</span>, <span style="color:#a6e22e">container</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">devicesToReuse</span>[string(<span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">UID</span>)]); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">podDevices</span>.<span style="color:#a6e22e">removeContainerAllocatedResources</span>(string(<span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">UID</span>), <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">devicesToReuse</span>[string(<span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">UID</span>)])
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>The <code>GetCapacity</code> method, which is called by the kubelet to get the capacity of the device plugin, returns the total number of devices available for each resource type. This information is used to determine whether a pod can be scheduled on a node based on the requested resources.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ManagerImpl</span>) <span style="color:#a6e22e">GetCapacity</span>() (<span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">ResourceList</span>, <span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">ResourceList</span>, []<span style="color:#66d9ef">string</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">needsUpdateCheckpoint</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">capacity</span> = <span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">ResourceList</span>{}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">allocatable</span> = <span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">ResourceList</span>{}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">deletedResources</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sets</span>.<span style="color:#a6e22e">New</span>[<span style="color:#66d9ef">string</span>]()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">mutex</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">resourceName</span>, <span style="color:#a6e22e">devices</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">healthyDevices</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">eI</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">endpoints</span>[<span style="color:#a6e22e">resourceName</span>]
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">ok</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">eI</span>.<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">stopGracePeriodExpired</span>()) <span style="color:#f92672">||</span> !<span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// The resources contained in endpoints and (un)healthyDevices
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#75715e">// should always be consistent. Otherwise, we run with the risk
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#75715e">// of failing to garbage collect non-existing resources or devices.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">ErrorS</span>(<span style="color:#66d9ef">nil</span>, <span style="color:#e6db74">&#34;Unexpected: healthyDevices and endpoints are out of sync&#34;</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			delete(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">endpoints</span>, <span style="color:#a6e22e">resourceName</span>)
</span></span><span style="display:flex;"><span>			delete(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">healthyDevices</span>, <span style="color:#a6e22e">resourceName</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">deletedResources</span>.<span style="color:#a6e22e">Insert</span>(<span style="color:#a6e22e">resourceName</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">needsUpdateCheckpoint</span> = <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>		} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">capacity</span>[<span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">ResourceName</span>(<span style="color:#a6e22e">resourceName</span>)] = <span style="color:#f92672">*</span><span style="color:#a6e22e">resource</span>.<span style="color:#a6e22e">NewQuantity</span>(int64(<span style="color:#a6e22e">devices</span>.<span style="color:#a6e22e">Len</span>()), <span style="color:#a6e22e">resource</span>.<span style="color:#a6e22e">DecimalSI</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">allocatable</span>[<span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">ResourceName</span>(<span style="color:#a6e22e">resourceName</span>)] = <span style="color:#f92672">*</span><span style="color:#a6e22e">resource</span>.<span style="color:#a6e22e">NewQuantity</span>(int64(<span style="color:#a6e22e">devices</span>.<span style="color:#a6e22e">Len</span>()), <span style="color:#a6e22e">resource</span>.<span style="color:#a6e22e">DecimalSI</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">resourceName</span>, <span style="color:#a6e22e">devices</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">unhealthyDevices</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">eI</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">endpoints</span>[<span style="color:#a6e22e">resourceName</span>]
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">ok</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">eI</span>.<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">stopGracePeriodExpired</span>()) <span style="color:#f92672">||</span> !<span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">ErrorS</span>(<span style="color:#66d9ef">nil</span>, <span style="color:#e6db74">&#34;Unexpected: unhealthyDevices and endpoints are out of sync&#34;</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			delete(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">endpoints</span>, <span style="color:#a6e22e">resourceName</span>)
</span></span><span style="display:flex;"><span>			delete(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">unhealthyDevices</span>, <span style="color:#a6e22e">resourceName</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">deletedResources</span>.<span style="color:#a6e22e">Insert</span>(<span style="color:#a6e22e">resourceName</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">needsUpdateCheckpoint</span> = <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>		} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">capacityCount</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">capacity</span>[<span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">ResourceName</span>(<span style="color:#a6e22e">resourceName</span>)]
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">unhealthyCount</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">resource</span>.<span style="color:#a6e22e">NewQuantity</span>(int64(<span style="color:#a6e22e">devices</span>.<span style="color:#a6e22e">Len</span>()), <span style="color:#a6e22e">resource</span>.<span style="color:#a6e22e">DecimalSI</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">capacityCount</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">unhealthyCount</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">capacity</span>[<span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">ResourceName</span>(<span style="color:#a6e22e">resourceName</span>)] = <span style="color:#a6e22e">capacityCount</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">mutex</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">needsUpdateCheckpoint</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">writeCheckpoint</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">ErrorS</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;Error on writing checkpoint&#34;</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">capacity</span>, <span style="color:#a6e22e">allocatable</span>, <span style="color:#a6e22e">deletedResources</span>.<span style="color:#a6e22e">UnsortedList</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="understanding-kubernetes-device-plugins-a-detailed-guide">Understanding Kubernetes Device Plugins: A Detailed Guide</h2>
<h3 id="the-design-of-managerimpl">The Design of <code>ManagerImpl</code></h3>
<p>The design of <code>ManagerImpl</code> provides an abstraction for device plugins, enabling Kubernetes to manage and schedule devices. It also allows for the dynamic operation of device plugins and adapts to changes in device status, such as device loss or plugin process restarts.</p>
<h2 id="summary">Summary</h2>
<p>From the analysis above, we can see that Device Plugins in Kubernetes act as &ldquo;translators&rdquo; for hardware devices:</p>
<ol>
<li>They convert hardware device information on nodes into Extended Resources, which the scheduler can use.</li>
<li>They translate container requests for hardware devices into actual device files and driver directories, passing this information to the container runtime.</li>
</ol>
<p>This plugin-based design gives Kubernetes strong support for hardware resources. Whether dealing with existing or new hardware devices, as long as there is a corresponding Device Plugin, the Kubernetes cluster can recognize and use the hardware.</p>
<p>Through this article, you should now have a deeper understanding of how Kubernetes Device Plugins work. If you have any questions, feel free to leave a comment for discussion.</p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://techmythos.substack.com/p/a-beginners-guide-to-building-a-kubernetes">https://techmythos.substack.com/p/a-beginners-guide-to-building-a-kubernetes</a></li>
<li><a href="https://kubernetes.io/blog/2022/12/19/devicemanager-ga/">https://kubernetes.io/blog/2022/12/19/devicemanager-ga/</a></li>
<li><a href="https://www.intel.com/content/www/us/en/developer/articles/technical/device-plugins-path-faster-workloads-in-kubernetes.html">https://www.intel.com/content/www/us/en/developer/articles/technical/device-plugins-path-faster-workloads-in-kubernetes.html</a></li>
<li><a href="https://artifacts.opnfv.org/ra2/jenkins-cntt-tox-ra2-1376/chapters/chapter03.html">https://artifacts.opnfv.org/ra2/jenkins-cntt-tox-ra2-1376/chapters/chapter03.html</a></li>
<li><a href="https://kubernetes.io/docs/concepts/extend-kubernetes/compute-storage-net/device-plugins/">https://kubernetes.io/docs/concepts/extend-kubernetes/compute-storage-net/device-plugins/</a></li>
</ul>
</section>

  
  

  
  
  
  
  

  
  

  
  

  


  
  <div class="giscus mt-24"></div>
  <script
    src="https://giscus.app/client.js"
    data-repo="haitwang-cloud/haitwang-cloud.github.io"
    data-repo-id="R_kgDOMH03cQ"
    data-category="General"
    data-category-id="DIC_kwDOMH03cc4CgVak"
    data-mapping="pathname"
    data-strict="1"
    data-reactions-enabled="0"
    data-emit-metadata="0"
    data-input-position="top"
    data-theme="light"
    data-lang="zh-CN"
    data-loading="lazy"
    crossorigin="anonymous"
    async
  ></script>
  
</article>


    </main>

    <footer
  class="opaco mx-auto flex h-[4.5rem] max-w-3xl items-center px-8 text-[0.9em] opacity-60"
>
  <div class="mr-auto">
    &copy; 2024
    <a class="link" href="http://localhost:1313/">Tim Wang Tech Blog</a>
  </div>
  <a class="link mx-6" href="https://gohugo.io/" rel="noopener" target="_blank"
    >Powered by Hugo️️</a
  >️
  <a
    class="link"
    href="https://github.com/nanxiaobei/hugo-paper"
    rel="noopener"
    target="_blank"
    >✎ Paper</a
  >
</footer>

  </body>
</html>
