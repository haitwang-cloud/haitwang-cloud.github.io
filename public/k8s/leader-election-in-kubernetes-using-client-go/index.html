<!doctype html>




<script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1313460867822205"
     crossorigin="anonymous"></script>





































<html
  class="not-ready lg:text-base"
  style="--bg: #f8f5d7"
  lang="zh-CN"
>
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, shrink-to-fit=no"
  />

  
  <title>ä½¿ç”¨client-goåœ¨Kubernetesä¸­è¿›è¡Œleader election - Tim Wangçš„æŠ€æœ¯åšå®¢</title>

  
  <meta name="theme-color" />

  
  
  
  
  <meta name="description" content="æœ¬æ–‡æ˜¯ leader-election-in-kubernetes-using-client-goçš„ä¸­æ–‡ç¿»è¯‘ç‰ˆæœ¬ï¼Œå†…å®¹æœ‰åˆ å‡
å¦‚æœæ‚¨æƒ³äº†è§£ Kubernetes ä¸­leader electionçš„å·¥ä½œåŸç†ï¼Œé‚£ä¹ˆå¸Œæœ›æœ¬æ–‡èƒ½å¯¹æ‚¨æœ‰æ‰€å¸®åŠ©ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®ºé«˜å¯ç”¨ç³»ç»Ÿä¸­leader electionçš„æ¦‚å¿µï¼Œå¹¶æ¢è®¨kubernetes/client-goåº“ï¼Œä»¥äº†è§£å…¶åœ¨ Kubernetes æ§åˆ¶å™¨ä¸­çš„åº”ç”¨ã€‚
è¿‘å¹´æ¥ï¼Œâ€œé«˜å¯ç”¨æ€§â€ä¸€è¯å› å¯é ç³»ç»Ÿå’ŒåŸºç¡€è®¾æ–½éœ€æ±‚çš„å¢åŠ è€Œå˜å¾—æµè¡Œèµ·æ¥ã€‚åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œé«˜å¯ç”¨æ€§é€šå¸¸æ¶‰åŠæœ€å¤§åŒ–è¿è¡Œæ—¶é—´å’Œç³»ç»Ÿå®¹é”™ã€‚é«˜å¯ç”¨æ€§ä¸­é€šå¸¸é‡‡ç”¨çš„ä¸€ç§åšæ³•æ˜¯ä½¿ç”¨å†—ä½™æ¥é¿å…å•ç‚¹æ•…éšœã€‚ä¸ºå†—ä½™åšå¥½ç³»ç»Ÿå’ŒæœåŠ¡çš„å‡†å¤‡å·¥ä½œå¯èƒ½åªéœ€è¦åœ¨è´Ÿè½½å‡è¡¡å™¨åé¢éƒ¨ç½²æ›´å¤šçš„å‰¯æœ¬ã€‚è™½ç„¶è¿™æ ·çš„é…ç½®å¯¹è®¸å¤šåº”ç”¨ç¨‹åºæ¥è¯´å¯èƒ½æœ‰æ•ˆï¼Œä½†æœ‰äº›ç”¨ä¾‹éœ€è¦åœ¨å‰¯æœ¬ä¹‹é—´è¿›è¡Œä»”ç»†çš„åè°ƒæ‰èƒ½ä½¿ç³»ç»Ÿæ­£ç¡®è¿è¡Œã€‚
ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­æ˜¯å½“ä¸€ä¸ª Kubernetes æ§åˆ¶å™¨è¢«éƒ¨ç½²ä¸ºå¤šä¸ªå®ä¾‹æ—¶ã€‚ä¸ºäº†é˜²æ­¢ä»»ä½•æ„å¤–çš„è¡Œä¸ºï¼Œleader electionè¿‡ç¨‹å¿…é¡»ç¡®ä¿åœ¨å‰¯æœ¬ä¹‹é—´é€‰å‡ºä¸€ä¸ªleaderï¼Œå¹¶ä¸”è¯¥leaderæ˜¯å”¯ä¸€ä¸»åŠ¨åè°ƒé›†ç¾¤çš„å®ä¾‹ã€‚å…¶ä»–å®ä¾‹åº”è¯¥ä¿æŒä¸æ´»åŠ¨ï¼Œä½†éšæ—¶å‡†å¤‡æ¥ç®¡leaderå®ä¾‹çš„å·¥ä½œï¼Œä»¥é˜²å…¶å¤±è´¥ã€‚
åœ¨ Kubernetes ä¸­ï¼Œleader electionçš„è¿‡ç¨‹å¾ˆç®€å•ã€‚å®ƒå§‹äºåˆ›å»ºä¸€ä¸ªé”å¯¹è±¡ï¼Œleaderä¼šå®šæœŸæ›´æ–°å½“å‰æ—¶é—´æˆ³ï¼Œä»¥é€šçŸ¥å…¶ä»–å‰¯æœ¬å…¶é¢†å¯¼æƒã€‚è¿™ä¸ªé”å¯¹è±¡å¯ä»¥æ˜¯ä¸€ä¸ªLeaseï¼ŒConfigMapæˆ–è€…Endpointï¼Œå®ƒè¿˜ä¿å­˜äº†å½“å‰leaderçš„èº«ä»½ã€‚å¦‚æœleaderåœ¨ç»™å®šçš„æ—¶é—´é—´éš”å†…æœªèƒ½æ›´æ–°æ—¶é—´æˆ³ï¼Œåˆ™è®¤ä¸ºå®ƒå·²ç»å´©æºƒï¼Œæ­¤æ—¶éæ´»åŠ¨å‰¯æœ¬ä¼šç«äº‰æ›´æ–°é”ï¼Œä»¥è·å–é¢†å¯¼æƒã€‚æˆåŠŸè·å–é”çš„podå°†æˆä¸ºæ–°çš„leaderã€‚
åœ¨æˆ‘ä»¬å¼€å§‹å†™ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚
é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæœ¬åœ°çš„Kubernetesé›†ç¾¤ã€‚æˆ‘å°†ä½¿ç”¨ KinDï¼Œä½†æ˜¯æ‚¨å¯ä»¥éšæ„é€‰æ‹©ä¸€ä¸ªæœ¬åœ°çš„k8så‘è¡Œç‰ˆã€‚
$ kind create cluster Creating cluster &#34;kind&#34; ... âœ“ Ensuring node image (kindest/node:v1.21.1) ğŸ–¼ âœ“ Preparing nodes ğŸ“¦ âœ“ Writing configuration ğŸ“œ âœ“ Starting control-plane ğŸ•¹ï¸ âœ“ Installing CNI ğŸ”Œ âœ“ Installing StorageClass ğŸ’¾ Set kubectl context to &#34;kind-kind&#34; You can now use your cluster with:kubectl cluster-info --context kind-kindNot sure what to do next?" />
  <meta name="author" content="Tim Wang" />
  

  
  
  
  
  
  
  <link rel="preload stylesheet" as="style" href="http://localhost:1313/main.min.css" />

  
  
  
  
  
  <link rel="preload" as="image" href="http://localhost:1313/theme.png" />

  
  
  
  
  <link rel="preload" as="image" href="https://gravatar.com/haitaoking1993" />
  
  

  
  
  <link rel="preload" as="image" href="http://localhost:1313/github.svg" />
  
  <link rel="preload" as="image" href="http://localhost:1313/linkedin.svg" />
  
  <link rel="preload" as="image" href="http://localhost:1313/rss.svg" />
  
  

  
  
  <script
    defer
    src="http://localhost:1313/highlight.min.js"
    onload="hljs.initHighlightingOnLoad();"
  ></script>
  

  
  
  

  
  <link rel="icon" href="http://localhost:1313/favicon.ico" />
  <link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png" />

  
  <meta name="generator" content="Hugo 0.127.0">

  
  
  
</head>

  <body class="text-black duration-200 ease-out dark:text-white">
    <header class="mx-auto flex h-[4.5rem] max-w-3xl px-8 lg:justify-center">
  <div class="relative z-50 mr-auto flex items-center">
    <a
      class="-translate-x-[1px] -translate-y-[1px] text-2xl font-semibold"
      href="http://localhost:1313/"
      >Tim Wangçš„æŠ€æœ¯åšå®¢</a
    >
    <div
      class="btn-dark text-[0] ml-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]"
      role="button"
      aria-label="Dark"
    ></div>
  </div>

  <div
    class="btn-menu relative z-50 -mr-8 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden"
    role="button"
    aria-label="Menu"
  ></div>

  

  <script>
    
    const htmlClass = document.documentElement.classList;
    setTimeout(() => {
      htmlClass.remove('not-ready');
    }, 10);

    
    const btnMenu = document.querySelector('.btn-menu');
    btnMenu.addEventListener('click', () => {
      htmlClass.toggle('open');
    });

    
    const metaTheme = document.querySelector('meta[name="theme-color"]');
    const lightBg = '#f8f5d7'.replace(/"/g, '');
    const setDark = (isDark) => {
      metaTheme.setAttribute('content', isDark ? '#000' : lightBg);
      htmlClass[isDark ? 'add' : 'remove']('dark');
      localStorage.setItem('dark', isDark);
    };

    
    const darkScheme = window.matchMedia('(prefers-color-scheme: dark)');
    if (htmlClass.contains('dark')) {
      setDark(true);
    } else {
      const darkVal = localStorage.getItem('dark');
      setDark(darkVal ? darkVal === 'true' : darkScheme.matches);
    }

    
    darkScheme.addEventListener('change', (event) => {
      setDark(event.matches);
    });

    
    const btnDark = document.querySelector('.btn-dark');
    btnDark.addEventListener('click', () => {
      setDark(localStorage.getItem('dark') !== 'true');
    });
  </script>

  <div
    class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"
  >
    
    

    
    <nav
      class="mt-12 flex justify-center space-x-10 dark:invert lg:ml-12 lg:mt-0 lg:items-center lg:space-x-6"
    >
      
      <a
        class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./github.svg)"
        href="https://github.com/haitwang-cloud"
        target="_blank"
        rel="me"
      >
        github
      </a>
      
      <a
        class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./linkedin.svg)"
        href="https://linkedin.com/in/tim-wang-505213166"
        target="_blank"
        rel="me"
      >
        linkedin
      </a>
      
      <a
        class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./rss.svg)"
        href="http://localhost:1313/index.xml"
        target="_blank"
        rel="alternate"
      >
        rss
      </a>
      
    </nav>
    
  </div>
</header>


    <main
      class="prose prose-neutral relative mx-auto min-h-[calc(100%-9rem)] max-w-3xl px-8 pb-16 pt-12 dark:prose-invert"
    >
      

<article>
  <header class="mb-16">
    <h1 class="!my-0 pb-2.5">ä½¿ç”¨client-goåœ¨Kubernetesä¸­è¿›è¡Œleader election</h1>

    
    <div class="text-sm antialiased opacity-60">
      
      <time>Jun 16, 2024</time>
      
      
      
      
    </div>
    
  </header>

  <section><blockquote>
<p>æœ¬æ–‡æ˜¯ <a href="https://itnext.io/leader-election-in-kubernetes-using-client-go-a19cbe7a9a85">leader-election-in-kubernetes-using-client-go</a>çš„ä¸­æ–‡ç¿»è¯‘ç‰ˆæœ¬ï¼Œå†…å®¹æœ‰åˆ å‡</p>
</blockquote>
<p>å¦‚æœæ‚¨æƒ³äº†è§£ Kubernetes ä¸­leader electionçš„å·¥ä½œåŸç†ï¼Œé‚£ä¹ˆå¸Œæœ›æœ¬æ–‡èƒ½å¯¹æ‚¨æœ‰æ‰€å¸®åŠ©ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®ºé«˜å¯ç”¨ç³»ç»Ÿä¸­leader electionçš„æ¦‚å¿µï¼Œå¹¶æ¢è®¨<a href="https://github.com/kubernetes/client-go">kubernetes/client-go</a>åº“ï¼Œä»¥äº†è§£å…¶åœ¨ Kubernetes æ§åˆ¶å™¨ä¸­çš„åº”ç”¨ã€‚</p>
<p>è¿‘å¹´æ¥ï¼Œâ€œé«˜å¯ç”¨æ€§â€ä¸€è¯å› å¯é ç³»ç»Ÿå’ŒåŸºç¡€è®¾æ–½éœ€æ±‚çš„å¢åŠ è€Œå˜å¾—æµè¡Œèµ·æ¥ã€‚åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œé«˜å¯ç”¨æ€§é€šå¸¸æ¶‰åŠæœ€å¤§åŒ–è¿è¡Œæ—¶é—´å’Œç³»ç»Ÿå®¹é”™ã€‚é«˜å¯ç”¨æ€§ä¸­é€šå¸¸é‡‡ç”¨çš„ä¸€ç§åšæ³•æ˜¯ä½¿ç”¨å†—ä½™æ¥é¿å…å•ç‚¹æ•…éšœã€‚ä¸ºå†—ä½™åšå¥½ç³»ç»Ÿå’ŒæœåŠ¡çš„å‡†å¤‡å·¥ä½œå¯èƒ½åªéœ€è¦åœ¨è´Ÿè½½å‡è¡¡å™¨åé¢éƒ¨ç½²æ›´å¤šçš„å‰¯æœ¬ã€‚è™½ç„¶è¿™æ ·çš„é…ç½®å¯¹è®¸å¤šåº”ç”¨ç¨‹åºæ¥è¯´å¯èƒ½æœ‰æ•ˆï¼Œä½†æœ‰äº›ç”¨ä¾‹éœ€è¦åœ¨å‰¯æœ¬ä¹‹é—´è¿›è¡Œä»”ç»†çš„åè°ƒæ‰èƒ½ä½¿ç³»ç»Ÿæ­£ç¡®è¿è¡Œã€‚</p>
<p>ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­æ˜¯å½“ä¸€ä¸ª Kubernetes æ§åˆ¶å™¨è¢«éƒ¨ç½²ä¸ºå¤šä¸ªå®ä¾‹æ—¶ã€‚ä¸ºäº†é˜²æ­¢ä»»ä½•æ„å¤–çš„è¡Œä¸ºï¼Œleader electionè¿‡ç¨‹å¿…é¡»ç¡®ä¿åœ¨å‰¯æœ¬ä¹‹é—´é€‰å‡ºä¸€ä¸ªleaderï¼Œå¹¶ä¸”è¯¥leaderæ˜¯å”¯ä¸€ä¸»åŠ¨åè°ƒé›†ç¾¤çš„å®ä¾‹ã€‚å…¶ä»–å®ä¾‹åº”è¯¥ä¿æŒä¸æ´»åŠ¨ï¼Œä½†éšæ—¶å‡†å¤‡æ¥ç®¡leaderå®ä¾‹çš„å·¥ä½œï¼Œä»¥é˜²å…¶å¤±è´¥ã€‚</p>
<p>åœ¨ Kubernetes ä¸­ï¼Œleader electionçš„è¿‡ç¨‹å¾ˆç®€å•ã€‚å®ƒå§‹äºåˆ›å»ºä¸€ä¸ªé”å¯¹è±¡ï¼Œleaderä¼šå®šæœŸæ›´æ–°å½“å‰æ—¶é—´æˆ³ï¼Œä»¥é€šçŸ¥å…¶ä»–å‰¯æœ¬å…¶é¢†å¯¼æƒã€‚è¿™ä¸ªé”å¯¹è±¡å¯ä»¥æ˜¯ä¸€ä¸ª<code>Lease</code>ï¼Œ<code>ConfigMap</code>æˆ–è€…<code>Endpoint</code>ï¼Œå®ƒè¿˜ä¿å­˜äº†å½“å‰leaderçš„èº«ä»½ã€‚å¦‚æœleaderåœ¨ç»™å®šçš„æ—¶é—´é—´éš”å†…æœªèƒ½æ›´æ–°æ—¶é—´æˆ³ï¼Œåˆ™è®¤ä¸ºå®ƒå·²ç»å´©æºƒï¼Œæ­¤æ—¶éæ´»åŠ¨å‰¯æœ¬ä¼šç«äº‰æ›´æ–°é”ï¼Œä»¥è·å–é¢†å¯¼æƒã€‚æˆåŠŸè·å–é”çš„podå°†æˆä¸ºæ–°çš„leaderã€‚</p>
<p>åœ¨æˆ‘ä»¬å¼€å§‹å†™ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæœ¬åœ°çš„Kubernetesé›†ç¾¤ã€‚æˆ‘å°†ä½¿ç”¨ <a href="https://kind.sigs.k8s.io/docs/user/quick-start/">KinD</a>ï¼Œä½†æ˜¯æ‚¨å¯ä»¥éšæ„é€‰æ‹©ä¸€ä¸ªæœ¬åœ°çš„k8så‘è¡Œç‰ˆã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kind create cluster
</span></span><span style="display:flex;"><span>Creating cluster <span style="color:#e6db74">&#34;kind&#34;</span> ...
</span></span><span style="display:flex;"><span> âœ“ Ensuring node image <span style="color:#f92672">(</span>kindest/node:v1.21.1<span style="color:#f92672">)</span> ğŸ–¼
</span></span><span style="display:flex;"><span> âœ“ Preparing nodes ğŸ“¦
</span></span><span style="display:flex;"><span> âœ“ Writing configuration ğŸ“œ
</span></span><span style="display:flex;"><span> âœ“ Starting control-plane ğŸ•¹ï¸
</span></span><span style="display:flex;"><span> âœ“ Installing CNI ğŸ”Œ
</span></span><span style="display:flex;"><span> âœ“ Installing StorageClass ğŸ’¾
</span></span><span style="display:flex;"><span>Set kubectl context to <span style="color:#e6db74">&#34;kind-kind&#34;</span>
</span></span><span style="display:flex;"><span>You can now use your cluster with:kubectl cluster-info --context kind-kindNot sure what to <span style="color:#66d9ef">do</span> next? ğŸ˜…  Check out https://kind.sigs.k8s.io/docs/user/quick-start/
</span></span></code></pre></div><p>æˆ‘ä»¬å°†ä½¿ç”¨çš„ç¤ºä¾‹åº”ç”¨ç¨‹åºå¯ä»¥åœ¨<a href="https://github.com/mayankshah1607/k8s-leader-election">k8s-leader-election</a>ï¼Œå®ƒä½¿ç”¨<a href="https://github.com/kubernetes/client-go">kubernetes/client-go</a>å®ç°leader electionã€‚è®©æˆ‘ä»¬åœ¨æˆ‘ä»¬çš„é›†ç¾¤ä¸Šè¿è¡Œåº”ç”¨ç¨‹åºï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Setup required permissions for creating/getting Lease objects</span>
</span></span><span style="display:flex;"><span>$ kubectl apply -f rbac.yaml
</span></span><span style="display:flex;"><span>serviceaccount/leaderelection-sa created
</span></span><span style="display:flex;"><span>role.rbac.authorization.k8s.io/leaderelection-role created
</span></span><span style="display:flex;"><span>rolebinding.rbac.authorization.k8s.io/leaderelection-rolebinding created# Create deployment
</span></span><span style="display:flex;"><span>$ kubectl apply -f deploy.yaml
</span></span><span style="display:flex;"><span>deployment.apps/leaderelection created
</span></span></code></pre></div><p>è¿™å°†åˆ›å»ºä¸€ä¸ªåŒ…å«3ä¸ªpodï¼ˆå‰¯æœ¬ï¼‰çš„deploymentã€‚å¦‚æœæ‚¨ç­‰å¾…å‡ ç§’é’Ÿï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°å®ƒä»¬å¤„äº<code>Running</code>çŠ¶æ€ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>â¯ kubectl get pods
</span></span><span style="display:flex;"><span>NAME                              READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>leaderelection-6d5b456c9d-cfd2l   1/1     Running   <span style="color:#ae81ff">0</span>          19s
</span></span><span style="display:flex;"><span>leaderelection-6d5b456c9d-n2kx2   1/1     Running   <span style="color:#ae81ff">0</span>          19s
</span></span><span style="display:flex;"><span>leaderelection-6d5b456c9d-ph8nj   1/1     Running   <span style="color:#ae81ff">0</span>          19s
</span></span></code></pre></div><p>ä¸€æ—¦æ‚¨çš„podè¿è¡Œèµ·æ¥ï¼Œè®©æˆ‘ä»¬å°è¯•æŸ¥çœ‹å®ƒä»¬ä½œä¸ºleader electionè¿‡ç¨‹çš„ä¸€éƒ¨åˆ†åˆ›å»ºçš„<code>Lease</code>é”å¯¹è±¡ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl describe lease my-leaseName:         my-lease
</span></span><span style="display:flex;"><span>Namespace:    default
</span></span><span style="display:flex;"><span>Labels:       &lt;none&gt;
</span></span><span style="display:flex;"><span>Annotations:  &lt;none&gt;
</span></span><span style="display:flex;"><span>API Version:  coordination.k8s.io/v1
</span></span><span style="display:flex;"><span>Kind:         Lease
</span></span><span style="display:flex;"><span>Metadata:
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Spec:
</span></span><span style="display:flex;"><span>  Acquire Time:            2021-10-23T06:51:50.605570Z
</span></span><span style="display:flex;"><span>  Holder Identity:         leaderelection-56457b6c5c-fn725
</span></span><span style="display:flex;"><span>  Lease Duration Seconds:  <span style="color:#ae81ff">15</span>
</span></span><span style="display:flex;"><span>  Lease Transitions:       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  Renew Time:              2021-10-23T06:52:45.309478Z
</span></span></code></pre></div><p>æ ¹æ®è¿™ä¸ªï¼Œæˆ‘ä»¬å½“å‰çš„leader podæ˜¯<code>leaderelection-56457bc5c-fn725</code>ã€‚è®©æˆ‘ä»¬é€šè¿‡æŸ¥çœ‹æˆ‘ä»¬çš„podæ—¥å¿—æ¥éªŒè¯è¿™ä¸€ç‚¹ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># leader pod</span>
</span></span><span style="display:flex;"><span>$ kubectl logs leaderelection-56457b6c5c-fn725I1023 06:51:50.605439       <span style="color:#ae81ff">1</span> leaderelection.go:248<span style="color:#f92672">]</span> attempting to acquire leader lease default/my-lease...
</span></span><span style="display:flex;"><span>I1023 06:51:50.630111       <span style="color:#ae81ff">1</span> leaderelection.go:258<span style="color:#f92672">]</span> successfully acquired lease default/my-lease
</span></span><span style="display:flex;"><span>I1023 06:51:50.630141       <span style="color:#ae81ff">1</span> main.go:57<span style="color:#f92672">]</span> still the leader!
</span></span><span style="display:flex;"><span>I1023 06:51:50.630245       <span style="color:#ae81ff">1</span> main.go:36<span style="color:#f92672">]</span> doing stuff...# inactive pods
</span></span><span style="display:flex;"><span>$ kubectl logs leaderelection-56457b6c5c-n857k
</span></span><span style="display:flex;"><span>I1023 06:51:55.400797       <span style="color:#ae81ff">1</span> leaderelection.go:248<span style="color:#f92672">]</span> attempting to acquire leader lease default/my-lease...
</span></span><span style="display:flex;"><span>I1023 06:51:55.412780       <span style="color:#ae81ff">1</span> main.go:60<span style="color:#f92672">]</span> new leader is %sleaderelection-56457b6c5c-fn725# inactive pod
</span></span><span style="display:flex;"><span>$ kubectl logs leaderelection-56457b6c5c-s48kx
</span></span><span style="display:flex;"><span>I1023 06:51:52.905451       <span style="color:#ae81ff">1</span> leaderelection.go:248<span style="color:#f92672">]</span> attempting to acquire leader lease default/my-lease...
</span></span><span style="display:flex;"><span>I1023 06:51:52.915618       <span style="color:#ae81ff">1</span> main.go:60<span style="color:#f92672">]</span> new leader is %sleaderelection-56457b6c5c-fn725
</span></span></code></pre></div><p>å°è¯•åˆ é™¤leader podæ¥æ¨¡æ‹Ÿå´©æºƒï¼Œå¹¶æ£€æŸ¥<code>Lease</code>å¯¹è±¡çš„å†…å®¹æ¥åˆ¤æ–­æ˜¯å¦é€‰ä¸¾å‡ºäº†æ–°çš„leader</p>
<p>è¿™é‡Œçš„åŸºæœ¬æ€æƒ³æ˜¯ä½¿ç”¨åˆ†å¸ƒå¼é”æœºåˆ¶æ¥å†³å®šå“ªä¸ªè¿›ç¨‹å°†æˆä¸ºleaderã€‚è·å–é”çš„è¿›ç¨‹å°†æ‰§è¡Œæ‰€éœ€çš„ä»»åŠ¡ã€‚<code>main</code>å‡½æ•°æ˜¯æˆ‘ä»¬åº”ç”¨ç¨‹åºçš„å…¥å£ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå¯¹é”å¯¹è±¡çš„å¼•ç”¨ï¼Œå¹¶å¯åŠ¨ä¸€ä¸ªleader electionå¾ªç¯ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> (
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">leaseLockName</span>      <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">leaseLockNamespace</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">podName</span>            = <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Getenv</span>(<span style="color:#e6db74">&#34;POD_NAME&#34;</span>)
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">StringVar</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">leaseLockName</span>, <span style="color:#e6db74">&#34;lease-name&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">&#34;Name of lease lock&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">StringVar</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">leaseLockNamespace</span>, <span style="color:#e6db74">&#34;lease-namespace&#34;</span>, <span style="color:#e6db74">&#34;default&#34;</span>, <span style="color:#e6db74">&#34;Name of lease lock namespace&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">Parse</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">leaseLockName</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;missing lease-name flag&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">leaseLockNamespace</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;missing lease-namespace flag&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">config</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rest</span>.<span style="color:#a6e22e">InClusterConfig</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">client</span> = <span style="color:#a6e22e">clientset</span>.<span style="color:#a6e22e">NewForConfigOrDie</span>(<span style="color:#a6e22e">config</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;failed to get kubeconfig&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">cancel</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithCancel</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cancel</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">lock</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">getNewLock</span>(<span style="color:#a6e22e">leaseLockName</span>, <span style="color:#a6e22e">podName</span>, <span style="color:#a6e22e">leaseLockNamespace</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">runLeaderElection</span>(<span style="color:#a6e22e">lock</span>, <span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">podName</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>æˆ‘ä»¬é¦–å…ˆè§£æ<code>lease-name</code>å’Œ<code>lease-namespace</code>æ ‡å¿—ï¼Œä»¥è·å–å‰¯æœ¬å¿…é¡»ä½¿ç”¨çš„é”å¯¹è±¡çš„åç§°å’Œå‘½åç©ºé—´ã€‚<code>POD_NAME</code>ç¯å¢ƒå˜é‡çš„å€¼ï¼ˆ<a href="https://github.com/mayankshah1607/k8s-leader-election/blob/master/deploy.yaml#L26">deploy.yaml</a> manifest) ä¼šç”¨äºæ ‡è¯†<code>Lease</code>å¯¹è±¡ä¸­çš„leaderã€‚æœ€åï¼Œæˆ‘ä»¬ä½¿ç”¨è¿™äº›å‚æ•°åˆ›å»ºä¸€ä¸ªé”å¯¹è±¡æ¥å¯åŠ¨leader electionè¿‡ç¨‹ã€‚</p>
<p>The <code>runLeaderElection</code> function is where we initiate the leader election loop by calling <code>RunOrDie</code> . We pass a <code>LeaderElectionConfig</code> to it:</p>
<p><code>runLeaderElection</code>å‡½æ•°æ˜¯æˆ‘ä»¬é€šè¿‡è°ƒç”¨<code>RunOrDie</code>æ¥å¯åŠ¨leader electionå¾ªç¯çš„åœ°æ–¹ã€‚æˆ‘ä»¬å‘å®ƒä¼ é€’ä¸€ä¸ª<code>LeaderElectionConfig</code>ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">runLeaderElection</span>(<span style="color:#a6e22e">lock</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">resourcelock</span>.<span style="color:#a6e22e">LeaseLock</span>, <span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">id</span> <span style="color:#66d9ef">string</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">leaderelection</span>.<span style="color:#a6e22e">RunOrDie</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">leaderelection</span>.<span style="color:#a6e22e">LeaderElectionConfig</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Lock</span>:            <span style="color:#a6e22e">lock</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">ReleaseOnCancel</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">LeaseDuration</span>:   <span style="color:#ae81ff">15</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">RenewDeadline</span>:   <span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">RetryPeriod</span>:     <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Callbacks</span>: <span style="color:#a6e22e">leaderelection</span>.<span style="color:#a6e22e">LeaderCallbacks</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">OnStartedLeading</span>: <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">c</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">doStuff</span>()
</span></span><span style="display:flex;"><span>			},
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">OnStoppedLeading</span>: <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;no longer the leader, staying inactive.&#34;</span>)
</span></span><span style="display:flex;"><span>			},
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">OnNewLeader</span>: <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">current_id</span> <span style="color:#66d9ef">string</span>) {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">current_id</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">id</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;still the leader!&#34;</span>)
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;new leader is %s&#34;</span>, <span style="color:#a6e22e">current_id</span>)
</span></span><span style="display:flex;"><span>			},
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹client-goä¸­<code>RunOrDie</code>çš„å®ç°ã€‚</p>
<p><a href="https://github.com/kubernetes/client-go/blob/master/tools/leaderelection/leaderelection.go#L218-L227">https://github.com/kubernetes/client-go/blob/master/tools/leaderelection/leaderelection.go#L218-L227</a></p>
<p>å®ƒä½¿ç”¨æˆ‘ä»¬ä¼ é€’ç»™å®ƒçš„<code>LeaderElectorConfig</code>åˆ›å»ºä¸€ä¸ª<code>*LeaderElector</code>ï¼Œå¹¶åœ¨å…¶ä¸Šè°ƒç”¨<code>Run</code>æ–¹æ³•ï¼š</p>
<p><a href="https://github.com/kubernetes/client-go/blob/56656ba0e04ff501549162385908f5b7d14f5dc8/tools/leaderelection/leaderelection.go#L200-L213">https://github.com/kubernetes/client-go/blob/56656ba0e04ff501549162385908f5b7d14f5dc8/tools/leaderelection/leaderelection.go#L200-L213</a></p>
<p>è¿™ä¸ªæ–¹æ³•è´Ÿè´£è¿è¡Œleader electionå¾ªç¯ã€‚å®ƒé¦–å…ˆå°è¯•è·å–é”ï¼ˆä½¿ç”¨<code>le.acquire</code>ï¼‰ã€‚åœ¨æˆåŠŸåï¼Œå®ƒè¿è¡Œæˆ‘ä»¬ä¹‹å‰é…ç½®çš„<code>OnStartedLeading</code>å›è°ƒå¹¶å®šæœŸæ›´æ–°ç§Ÿçº¦ã€‚åœ¨æ— æ³•è·å–é”æ—¶ï¼Œå®ƒåªæ˜¯è¿è¡Œ<code>OnStoppedLeading</code>å›è°ƒå¹¶è¿”å›ã€‚</p>
<p>è¿™é‡Œæœ€é‡è¦çš„éƒ¨åˆ†æ˜¯<code>acquire</code>å’Œ<code>renew</code>æ–¹æ³•ä¸­å¯¹<code>tryAcquireOrRenew</code>çš„è°ƒç”¨ï¼Œå®ƒåŒ…å«äº†é”æœºåˆ¶çš„æ ¸å¿ƒé€»è¾‘ã€‚</p>
<h3 id="ä¼˜åŒ–é”å¹¶å‘æ§åˆ¶optimistic-locking-concurrency-control">ä¼˜åŒ–é”ï¼ˆå¹¶å‘æ§åˆ¶ï¼‰[Optimistic locking (concurrency control)]</h3>
<p>leader election è¿‡ç¨‹åˆ©ç”¨Kubernetesçš„åŸå­æ€§ï¼Œç¡®ä¿ä¸ä¼šæœ‰ä¸¤ä¸ªå®ä¾‹åŒæ—¶è·å–åˆ°<code>Lease</code>ä¸­çš„é”ï¼Œæ¯æ¬¡æ›´æ–° <code>Lease</code>ï¼ˆç»­è®¢æˆ–è·å–ï¼‰ï¼ŒKubernetes ä¹Ÿä¼šæ›´æ–°å…¶ä¸Šçš„ resourceVersion å­—æ®µã€‚å½“å¦ä¸€ä¸ªè¿›ç¨‹å°è¯•åŒæ—¶æ›´æ–° <code>Lease</code> æ—¶ï¼ŒKubernetes ä¼šæ£€æŸ¥æ›´æ–°å¯¹è±¡çš„ <code>resourceVersion</code> å­—æ®µæ˜¯å¦ä¸å½“å‰å¯¹è±¡åŒ¹é…â€”â€”å¦‚æœä¸åŒ¹é…ï¼Œåˆ™æ›´æ–°å¤±è´¥ï¼Œä»è€Œé˜²æ­¢å¹¶å‘é—®é¢˜ï¼</p>
<p>åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†leader electionçš„æ¦‚å¿µä»¥åŠå®ƒå¯¹åˆ†å¸ƒå¼ç³»ç»Ÿçš„é«˜å¯ç”¨æ€§çš„é‡è¦æ€§ã€‚æˆ‘ä»¬çœ‹äº†çœ‹Kubernetesæ˜¯å¦‚ä½•ä½¿ç”¨<code>Lease</code>é”æ¥å®ç°çš„ï¼Œå¹¶å°è¯•ä½¿ç”¨<a href="https://github.com/kubernetes/client-go/blob/master/tools/leaderelection/leaderelection.go">kubernetes/client-go</a>åº“ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜å°è¯•äº†è§£Kuberneteså¦‚ä½•ä½¿ç”¨åŸå­æ“ä½œå’Œä¹è§‚é”æ–¹æ³•æ¥é˜²æ­¢å¹¶å‘é—®é¢˜ã€‚</p>
<ul>
<li><a href="https://kubernetes.io/blog/2016/01/simple-leader-election-with-kubernetes/">https://kubernetes.io/blog/2016/01/simple-leader-election-with-kubernetes/</a></li>
<li><a href="https://medium.com/hybrid-cloud-hobbyist/leader-election-architecture-kubernetes-32600da81e3c">https://medium.com/hybrid-cloud-hobbyist/leader-election-architecture-kubernetes-32600da81e3c</a></li>
<li><a href="https://carlosbecker.com/posts/k8s-leader-election/">https://carlosbecker.com/posts/k8s-leader-election/</a></li>
<li><a href="https://taesunny.github.io/kubernetes/kubernetes-controllers-leader-election-with-go-library/">https://taesunny.github.io/kubernetes/kubernetes-controllers-leader-election-with-go-library/</a></li>
</ul>
</section>

  
  

  
  
  
  
  

  
  

  
  

  


  
  <div class="giscus mt-24"></div>
  <script
    src="https://giscus.app/client.js"
    data-repo="haitwang-cloud/haitwang-cloud.github.io"
    data-repo-id="R_kgDOMH03cQ"
    data-category="General"
    data-category-id="DIC_kwDOMH03cc4CgVak"
    data-mapping="pathname"
    data-strict="1"
    data-reactions-enabled="0"
    data-emit-metadata="0"
    data-input-position="top"
    data-theme="light"
    data-lang="zh-CN"
    data-loading="lazy"
    crossorigin="anonymous"
    async
  ></script>
  
</article>


    </main>

    <footer
  class="opaco mx-auto flex h-[4.5rem] max-w-3xl items-center px-8 text-[0.9em] opacity-60"
>
  <div class="mr-auto">
    &copy; 2024
    <a class="link" href="http://localhost:1313/">Tim Wangçš„æŠ€æœ¯åšå®¢</a>
  </div>
  <a class="link mx-6" href="https://gohugo.io/" rel="noopener" target="_blank"
    >Powered by Hugoï¸ï¸</a
  >ï¸
  <a
    class="link"
    href="https://github.com/nanxiaobei/hugo-paper"
    rel="noopener"
    target="_blank"
    >âœ Paper</a
  >
</footer>

  </body>
</html>
